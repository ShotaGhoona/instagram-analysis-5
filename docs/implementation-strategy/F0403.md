# F0403: 月間分析API連携・データ統合実装戦略

## 概要
月間分析ページのmockデータからリアルAPI連携への移行。B0303で実装した月間分析APIエンドポイントをフロントエンドと統合し、実際のデータベースデータを表示可能にする。F0304年間分析API連携と同じパターンで実装。

## 実装戦略

### 1. API Client拡張 (0.5時間)
`frontend/src/lib/api.ts`のgetMonthlyAnalyticsメソッド既存確認・調整
- **パラメータ確認**: year（必須）、month（必須）対応済み
- **エラーハンドリング**: APIエラー時の適切な処理
- **型安全性**: MonthlyAnalytics型レスポンス確保
- **既存パターン踏襲**: getYearlyAnalyticsと同じ構造

### 2. カスタムフック作成 (0.5時間)
`frontend/src/hooks/use-monthly-analytics.ts`を新規作成
- **データフェッチ**: API呼び出しとローディング状態管理
- **エラー状態**: エラー時の適切な状態管理
- **リフェッチ機能**: データ再取得機能
- **既存パターン踏襲**: use-yearly-analyticsと同じ構造

### 3. 月間分析ページ更新 (0.75時間)
`frontend/src/app/analytics/account/[accountId]/monthly/page.tsx`をmock→API切り替え
- **mockデータ削除**: import文とデータ参照を削除
- **API統合**: useMonthlyAnalyticsフック使用
- **ローディング状態**: Skeleton表示追加
- **エラー状態**: エラー表示とリトライ機能
- **フォールバック**: データなし時の適切な表示
- **年月パラメータ**: URLパラメータまたはデフォルト値設定

### 4. 動作確認・調整 (0.25時間)
- **E2Eテスト**: ブラウザでの動作確認
- **エラーケース**: 存在しないアカウント、無効な年月、ネットワークエラー
- **パフォーマンス**: ローディング時間確認

## 完了条件
- [ ] API ClientのgetMonthlyAnalyticsメソッド確認・調整
- [ ] カスタムフックでデータ取得・エラー・ローディング状態管理
- [ ] 月間分析ページがリアルAPIからデータ表示
- [ ] ローディング・エラー状態が適切に表示
- [ ] mockデータ完全削除、import文クリーンアップ
- [ ] 存在するアカウントで正常データ表示確認

## 技術仕様

### API Client確認
```typescript
// lib/api.ts (既存メソッド確認)
async getMonthlyAnalytics(accountId: string, year: number, month: number) {
  return this.request(`/analytics/monthly/${accountId}?year=${year}&month=${month}`)
}
```

### カスタムフック
```typescript
// hooks/use-monthly-analytics.ts
export function useMonthlyAnalytics(accountId: string, year: number, month: number) {
  const [data, setData] = useState<MonthlyAnalytics | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  // useEffect for API call
  // return { data, loading, error, refetch }
}
```

### ページ統合
```typescript
// app/analytics/account/[accountId]/monthly/page.tsx
export default function MonthlyAnalyticsPage({ params }: MonthlyAnalyticsPageProps) {
  const resolvedParams = use(params)
  
  // デフォルト年月設定（現在年月または固定値）
  const currentDate = new Date()
  const defaultYear = currentDate.getFullYear()
  const defaultMonth = currentDate.getMonth() + 1
  
  const { data, loading, error, refetch } = useMonthlyAnalytics(
    resolvedParams.accountId, 
    defaultYear, 
    defaultMonth
  )

  if (loading) return <MonthlyPageSkeleton />
  if (error) return <ErrorDisplay error={error} onRetry={refetch} />
  if (!data || !data.daily_stats.length) return <NoDataDisplay />

  return (
    <div>
      <MonthlyTable data={data} />
      <MonthlyCharts data={data.daily_stats} />
    </div>
  )
}
```

## エラーハンドリング仕様

### エラーケース対応
- **400**: 無効な年月指定 → "無効な年月が指定されました"
- **404**: アカウント不存在 → "アカウントが見つかりません"
- **500**: サーバーエラー → "データ取得に失敗しました"
- **Network**: 接続エラー → "ネットワークエラーです"
- **No Data**: データなし → "データがありません"

### ローディング状態
- **Skeleton**: テーブル・グラフ部分のSkeleton表示
- **初回ロード**: ページ全体のローディング
- **リフェッチ**: ボタン無効化

## データフロー変更

### Before (mockデータ)
```
Page → mockMonthlyData → Components
```

### After (API統合)
```
Page → useMonthlyAnalytics → API → Database → Components
```

## 年月パラメータ設定

### デフォルト年月
- **現在月**: `new Date()`から算出
- **固定値**: 2025年3月（テストデータ期間）
- **URL拡張**: 将来的にURLパラメータ対応可能

### 実装例
```typescript
// デフォルト年月設定
const currentDate = new Date()
const year = currentDate.getFullYear()
const month = currentDate.getMonth() + 1

// またはテスト用固定値
const year = 2025
const month = 3
```

## PoC配慮
- **エラーハンドリング最小限**: 基本的な表示のみ
- **リトライ機能**: シンプルなボタンクリック再実行
- **キャッシュなし**: 毎回API呼び出し
- **パフォーマンス**: 基本的な最適化のみ
- **年月固定**: 動的な年月選択は将来実装

## 次への依存関係
- **B0303 月間分析API**: 既に実装完了
- **F0304パターン踏襲**: 年間分析API統合と同じ実装手法
- **将来拡張**: 年月選択UI、期間フィルター機能