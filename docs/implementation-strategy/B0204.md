# B0204: インサイトデータ取得

## 概要
Instagram Graph APIから投稿別インサイトメトリクス（reach, views, shares, saved）を取得する機能を実装。
verification検証で**完全動作確認済み**（6件の投稿で全メトリクス100%取得成功）。

## 検証データ分析結果

### 📊 検証済みメトリクス
- **reach**: 100%成功 (6/6件) - 0〜67ユーザーの実用的な範囲
- **shares**: 100%成功 (6/6件) - 全投稿で正確なシェア状況反映
- **saved**: 100%成功 (6/6件) - 実際の保存行動を正確検出
- **views**: 100%成功 (5/5件) - VIDEO投稿で242〜622回の視聴数取得

### ⚠️ 廃止メトリクス
- **video_views**: 2025年4月廃止 → `views`メトリクスで統一対応

## 実装戦略

### 1. Instagram APIクライアント拡張 (2時間)
**ファイル**: `backend/external/instagram_client.py`

```python
def get_media_insights(self, ig_media_id: str, access_token: str, metrics: List[str] = None) -> Dict[str, Any]:
    """Get insights for specific media post"""
    if metrics is None:
        metrics = ['reach', 'shares', 'saved', 'views']  # 検証済みメトリクス
    
    insights_result = {}
    for metric in metrics:
        params = {
            'metric': metric,
            'access_token': access_token
        }
        result = self.graph_api_request(f'/{ig_media_id}/insights', params)
        insights_result[metric] = result
    
    return insights_result
```

### 2. データベースリポジトリ拡張 (1.5時間)
**ファイル**: `backend/repositories/instagram_repository.py`

```python
async def save_daily_media_stats(self, media_stats: List[Dict]) -> int:
    """Save daily media statistics to database (UPSERT)"""
    # daily_media_statsテーブルへの保存処理
    
async def get_media_stats(self, ig_media_id: str, date_range: Optional[tuple] = None) -> List[Dict]:
    """Get media statistics from database"""
    # 日次統計データ取得
```

### 3. サービス層統合 (1.5時間)
**ファイル**: `backend/services/instagram_service.py`

```python
async def collect_media_insights(self, ig_media_id: str, media_type: str, access_token: str) -> Dict[str, Any]:
    """Collect media insights from Instagram API and save to database"""
    # メディアタイプに応じたメトリクス選択
    # API取得 → データベース保存の一連処理
```

### 4. API エンドポイント実装 (1時間)
**ファイル**: `backend/api/media.py`

既存の`get_media_insights()`のTODO実装:
```python
@router.get("/{media_id}/insights")
async def get_media_insights(media_id: str, current_user: User = Depends(get_current_user)):
    # Instagram APIから最新インサイト取得
    # またはデータベースから履歴取得
```

## 完了条件
- [ ] `instagram_client.py` に `get_media_insights()` メソッド追加
- [ ] `instagram_repository.py` にインサイトデータCRUD操作追加
- [ ] `instagram_service.py` にインサイト収集機能追加
- [ ] `api/media.py` のインサイトエンドポイント実装完了
- [ ] メディアタイプ別メトリクス対応（VIDEO: views追加、他: reach/shares/saved）
- [ ] 実データでエンドツーエンド動作確認

## PoC配慮
- **メトリクス選択**: 検証済み4種類のみ（reach, shares, saved, views）
- **エラーハンドリング**: 最小限（API制限・メトリクス未対応）
- **データ履歴**: 簡易実装（日次UPSERTのみ）
- **パフォーマンス**: 考慮しない（同期処理）
- **廃止メトリクス**: video_viewsは実装しない（viewsで統一）

## 検証済み技術仕様

### APIパラメータ（完全動作確認済み）
```python
# 全投稿タイプ対応
metrics = ['reach', 'shares', 'saved']

# VIDEO投稿追加対応  
if media_type == 'VIDEO':
    metrics.append('views')  # 新統一メトリクス

# APIリクエスト
params = {
    'metric': metric,  # 単一メトリクスで呼び出し
    'access_token': long_lived_token
}
```

### データ構造
```python
insights_data = {
    "reach": {"success": True, "value": 67},
    "shares": {"success": True, "value": 0}, 
    "saved": {"success": True, "value": 1},
    "views": {"success": True, "value": 622}  # VIDEO only
}
```

## 依存関係
- **前提**: B0203 (メディア投稿取得) ✅ 完了済み
- **連携**: B0205 (アカウントインサイト取得) - 異なるエンドポイント
- **活用**: B0401 (GitHub Actions データ収集) - この機能を使用

## 制約・注意事項
- Instagram API制限: メトリクス別に個別リクエスト必要
- アクセストークン: 長期トークン推奨（短期トークンは不安定）
- メトリクス可用性: アカウントタイプ・投稿年数により制限あり
- 廃止メトリクス: video_viewsは2025年4月廃止済み → viewsで対応