# B0205: アカウントインサイト取得

## 概要
Instagram Graph APIからアカウントレベルインサイト（profile_views, website_clicks）を取得する機能を実装。
verification検証で**技術的完全成功**（5アカウント全て接続成功、API仕様完全確立）。

## 検証データ分析結果

### 📊 検証済みメトリクス
- **profile_views**: 100%成功 (5/5アカウント) - プロフィール閲覧数
- **website_clicks**: 100%成功 (5/5アカウント) - ウェブサイトクリック数
- **API接続**: 100%成功 - 長期トークンで安定動作

### ⚠️ 削除対象メトリクス
- **impressions**: Instagram Graph APIで存在しない（削除確定）

### 🔧 確立した技術仕様
```python
# 完全対応済みAPI呼び出し（2025年9月現在）
params = {
    'metric': 'profile_views,website_clicks',
    'period': 'day',
    'metric_type': 'total_value',  # 必須パラメータ
    'access_token': long_lived_token
}
response = client.graph_api_request(f'{ig_account_id}/insights', params=params)
```

## 実装戦略

### 1. Instagram APIクライアント拡張 (1時間)
**ファイル**: `backend/external/instagram_client.py`

```python
def get_account_insights(self, ig_user_id: str, access_token: str, metrics: List[str] = None) -> Dict[str, Any]:
    """Get account-level insights"""
    if metrics is None:
        metrics = ['profile_views', 'website_clicks']  # 検証済みメトリクス
    
    params = {
        'metric': ','.join(metrics),
        'period': 'day',
        'metric_type': 'total_value',  # 必須パラメータ
        'access_token': access_token
    }
    return self.graph_api_request(f'/{ig_user_id}/insights', params)
```

### 2. データベースリポジトリ拡張 (1時間)
**ファイル**: `repositories/instagram_repository.py`

```python
async def save_daily_account_insights(self, account_insights: List[Dict]) -> int:
    """Save daily account insights to daily_account_stats table"""
    # profile_views, website_clicksをdaily_account_statsテーブルに保存
    # 既存のfollowers_count等と同じテーブルを活用
    
async def get_latest_account_insights(self, ig_user_ids: List[str]) -> Dict[str, Dict]:
    """Get latest account insights for multiple accounts"""
    # 最新のアカウントインサイトデータ取得
```

### 3. サービス層統合 (1時間)  
**ファイル**: `services/instagram_service.py`

```python
async def collect_account_insights(self, ig_user_id: str, access_token: str) -> Dict[str, Any]:
    """Collect account insights from Instagram API and save to database"""
    # アカウントレベルインサイト取得 → データベース保存
    
async def collect_all_account_insights(self, accounts: List[InstagramAccount]) -> Dict[str, Any]:
    """Collect insights for all accounts"""
    # 全アカウントのインサイト一括収集
```

## 完了条件
- [ ] `instagram_client.py` に `get_account_insights()` メソッド追加
- [ ] `instagram_repository.py` にアカウントインサイトCRUD操作追加
- [ ] `instagram_service.py` にアカウントインサイト収集機能追加
- [ ] 検証済みAPIパラメータ(`metric_type=total_value`)の正確な実装
- [ ] 実データでエンドツーエンド動作確認

## PoC配慮
- **メトリクス選択**: 検証済み2種類のみ（profile_views, website_clicks）
- **期間指定**: day固定（検証済み仕様）
- **エラーハンドリング**: 最小限（API制限・メトリクス未対応）
- **データ統合**: 既存daily_account_statsテーブル活用
- **削除メトリクス**: impressionsは実装しない（API存在せず）

## 検証済み技術仕様

### APIパラメータ（完全動作確認済み）
```python
# 必須パラメータ構成
params = {
    'metric': 'profile_views,website_clicks',  # カンマ区切りで複数指定可能
    'period': 'day',                           # 日次データ固定
    'metric_type': 'total_value',              # 必須パラメータ
    'access_token': long_lived_token           # 長期トークン推奨
}
```

### データ構造（検証済み）
```python
# APIレスポンス構造
response = {
    "data": [
        {
            "name": "profile_views",
            "period": "day", 
            "values": [{"value": 0, "end_time": "2025-09-09T07:00:00+0000"}]
        },
        {
            "name": "website_clicks",
            "period": "day",
            "values": [{"value": 0, "end_time": "2025-09-09T07:00:00+0000"}]
        }
    ]
}
```

## 依存関係
- **前提**: B0201 (API認証統合) ✅ 完了済み
- **連携**: B0204 (メディアインサイト取得) - 異なるエンドポイント
- **活用**: B0401 (GitHub Actions データ収集) - この機能を使用

## 制約・注意事項
- Instagram API制限: アカウントレベルは制限が緩い
- アクセストークン: 長期トークン必須
- メトリクス可用性: Business Accountのみ利用可能
- データ特性: アクセスが少ないアカウントでは0値が正常
- 必須パラメータ: `metric_type=total_value`を必ず指定

## 検証結果に基づく実装方針
- **技術面**: 100%実装可能（全アカウントで動作確認済み）
- **データ面**: 実際のアクセス状況を正確反映（0値は正常）
- **運用面**: 毎日収集システムに即座に組み込み可能