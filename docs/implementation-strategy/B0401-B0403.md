# B0401-B0403: GitHub Actions データ収集システム

## 概要
Instagram分析アプリの自動データ収集システムを構築。B0203-B0205で実装済みの機能を統合し、GitHub Actionsで日次実行する完全自動化システム。

## 前提条件 ✅ 完了済み
- **B0203**: メディア投稿取得 ✅ 完了
- **B0204**: インサイトデータ取得 ✅ 完了  
- **B0205**: アカウントインサイト取得 ✅ 完了
- **Supabase接続**: 本番データベース稼働中
- **Instagram API**: 長期トークン管理システム完備

---

## B0401: 収集スクリプト作成 (6時間)

### 実装戦略

#### 1. 統合データ収集スクリプト作成 (3時間)
**ファイル**: `scripts/daily_data_collection.py`

```python
#!/usr/bin/env python3
"""
Instagram Daily Data Collection Script

GitHub Actions用の統合データ収集スクリプト
- 全アカウントの基本情報更新
- 投稿データ収集（新規検出・保存）
- インサイトデータ収集（投稿毎）
- アカウントインサイト収集（アカウント毎）
"""

import asyncio
import sys
import os
from datetime import datetime
from typing import Dict, Any, List

# Backend path setup
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'backend'))

from repositories.instagram_repository import instagram_repository
from services.instagram_service import instagram_service

async def collect_all_instagram_data() -> Dict[str, Any]:
    """Complete Instagram data collection pipeline"""
    
    print("🚀 Instagram Daily Data Collection 開始")
    print(f"📅 実行日時: {datetime.now().strftime('%Y年%m月%d日 %H:%M:%S')}")
    
    results = {
        "execution_time": datetime.now().isoformat(),
        "accounts_processed": 0,
        "media_posts_collected": 0,
        "insights_collected": 0,
        "account_insights_collected": 0,
        "errors": []
    }
    
    try:
        # 1. Get all Instagram accounts
        accounts = await instagram_repository.get_all()
        if not accounts:
            results["errors"].append("No Instagram accounts found in database")
            return results
        
        print(f"📋 対象アカウント: {len(accounts)}件")
        results["accounts_processed"] = len(accounts)
        
        # Convert to service format
        accounts_data = []
        for account in accounts:
            accounts_data.append({
                'name': account.name,
                'ig_user_id': account.ig_user_id,
                'access_token': account.access_token,
                'username': account.username
            })
        
        # 2. Collect media posts for all accounts
        print("\n📸 Step 1: 投稿データ収集...")
        media_results = []
        for account_data in accounts_data:
            result = await instagram_service.collect_media_posts(
                account_data['ig_user_id'], 
                account_data['access_token']
            )
            media_results.append({
                "account": account_data['name'],
                "result": result
            })
            
            if result.get("success"):
                results["media_posts_collected"] += result.get("collected_posts", 0)
            else:
                results["errors"].append(f"Media posts failed for {account_data['name']}: {result.get('error')}")
        
        # 3. Collect media insights for all accounts
        print("\n📊 Step 2: 投稿インサイト収集...")
        insights_results = []
        for account_data in accounts_data:
            result = await instagram_service.collect_all_media_insights(
                account_data['ig_user_id'], 
                account_data['access_token']
            )
            insights_results.append({
                "account": account_data['name'],
                "result": result
            })
            
            if result.get("success"):
                results["insights_collected"] += result.get("successful_media", 0)
            else:
                results["errors"].append(f"Media insights failed for {account_data['name']}: {result.get('error')}")
        
        # 4. Collect account insights
        print("\n📈 Step 3: アカウントインサイト収集...")
        account_insights_result = await instagram_service.collect_all_account_insights(accounts_data)
        
        if account_insights_result.get("success"):
            results["account_insights_collected"] = account_insights_result.get("successful_accounts", 0)
        else:
            results["errors"].append(f"Account insights failed: {account_insights_result.get('error')}")
        
        # 5. Summary
        print(f"\n🏁 Instagram Daily Data Collection 完了")
        print(f"📊 収集サマリー:")
        print(f"   🔍 処理アカウント: {results['accounts_processed']}件")
        print(f"   📸 投稿データ: {results['media_posts_collected']}件")
        print(f"   📊 インサイト: {results['insights_collected']}件")
        print(f"   📈 アカウントインサイト: {results['account_insights_collected']}件")
        print(f"   ❌ エラー: {len(results['errors'])}件")
        
        return results
        
    except Exception as e:
        error_msg = f"Critical error in data collection: {str(e)}"
        results["errors"].append(error_msg)
        print(f"❌ {error_msg}")
        return results

if __name__ == "__main__":
    results = asyncio.run(collect_all_instagram_data())
    
    # Exit with error code if there were critical failures
    if len(results["errors"]) > 0:
        print(f"⚠️ Collection completed with {len(results['errors'])} errors")
        sys.exit(1)
    else:
        print("✅ Collection completed successfully")
        sys.exit(0)
```

#### 2. 環境変数管理スクリプト (1時間)
**ファイル**: `scripts/setup_environment.py`

```python
#!/usr/bin/env python3
"""
Environment Setup for GitHub Actions
"""

import os

def setup_environment():
    """Setup environment variables for data collection"""
    required_vars = [
        'SUPABASE_URL',
        'SUPABASE_KEY',
        'INSTAGRAM_APP_ID',
        'INSTAGRAM_APP_SECRET'
    ]
    
    missing_vars = []
    for var in required_vars:
        if not os.getenv(var):
            missing_vars.append(var)
    
    if missing_vars:
        print(f"❌ Missing environment variables: {', '.join(missing_vars)}")
        return False
    
    print("✅ All required environment variables are set")
    return True

if __name__ == "__main__":
    import sys
    success = setup_environment()
    sys.exit(0 if success else 1)
```

#### 3. 依存関係管理 (1時間)
**ファイル**: `scripts/requirements.txt`

```txt
# GitHub Actions用の最小限の依存関係
supabase==2.7.4
requests==2.31.0
python-dotenv==1.0.0
asyncio
```

#### 4. ログ・エラーレポート機能 (1時間)
**ファイル**: `scripts/report_generator.py`

```python
#!/usr/bin/env python3
"""
Data Collection Report Generator
"""

import json
from datetime import datetime
from typing import Dict, Any

def generate_collection_report(results: Dict[str, Any]) -> str:
    """Generate human-readable collection report"""
    
    report = f"""
# Instagram Data Collection Report
**実行日時**: {results.get('execution_time', 'Unknown')}

## 📊 収集結果サマリー
- **処理アカウント**: {results.get('accounts_processed', 0)}件
- **投稿データ**: {results.get('media_posts_collected', 0)}件
- **インサイト**: {results.get('insights_collected', 0)}件  
- **アカウントインサイト**: {results.get('account_insights_collected', 0)}件

## ❌ エラー状況
"""
    
    errors = results.get('errors', [])
    if errors:
        for i, error in enumerate(errors, 1):
            report += f"{i}. {error}\n"
    else:
        report += "エラーなし ✅\n"
    
    return report

if __name__ == "__main__":
    # Example usage
    sample_results = {
        "execution_time": datetime.now().isoformat(),
        "accounts_processed": 5,
        "media_posts_collected": 25,
        "insights_collected": 25,
        "account_insights_collected": 5,
        "errors": []
    }
    
    print(generate_collection_report(sample_results))
```

---

## B0402: GitHub Actionsワークフロー (3時間)

### 実装戦略

#### 1. メインワークフローファイル作成 (2時間)
**ファイル**: `.github/workflows/daily-data-collection.yml`

```yaml
name: Instagram Daily Data Collection

on:
  schedule:
    # 毎日 JST 09:00 (UTC 00:00) に実行
    - cron: '0 0 * * *'
  workflow_dispatch:  # 手動実行も可能
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  collect-instagram-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30分でタイムアウト
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r scripts/requirements.txt
    
    - name: Verify environment variables
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
        INSTAGRAM_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
      run: |
        python scripts/setup_environment.py
    
    - name: Run Instagram data collection
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
        INSTAGRAM_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
        DEBUG_MODE: ${{ github.event.inputs.debug || 'false' }}
      run: |
        python scripts/daily_data_collection.py
    
    - name: Generate collection report
      if: always()  # 成功・失敗に関わらず実行
      run: |
        echo "Data collection completed at $(date)"
        echo "Check the logs above for detailed results"
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: collection-logs
        path: |
          *.log
          logs/
        retention-days: 7
```

#### 2. 環境変数・シークレット設定ガイド (0.5時間)
**ファイル**: `docs/deployment/github-actions-setup.md`

```markdown
# GitHub Actions セットアップガイド

## 必要なシークレット設定

GitHub リポジトリの Settings > Secrets and variables > Actions で以下を設定:

### Repository Secrets
- `SUPABASE_URL`: Supabaseプロジェクトの URL
- `SUPABASE_KEY`: Supabaseの anon/service_role キー
- `INSTAGRAM_APP_ID`: Instagram アプリ ID
- `INSTAGRAM_APP_SECRET`: Instagram アプリ シークレット

### 設定方法
1. GitHub リポジトリページで Settings クリック
2. 左サイドバーの "Secrets and variables" > "Actions" クリック
3. "New repository secret" で各項目を追加

## 手動実行方法
1. Actions タブに移動
2. "Instagram Daily Data Collection" ワークフローを選択
3. "Run workflow" ボタンをクリック
4. 必要に応じてデバッグモードを有効化
```

#### 3. エラーハンドリング・通知設定 (0.5時間)
**ファイル**: `.github/workflows/notify-on-failure.yml`

```yaml
name: Collection Failure Notification

on:
  workflow_run:
    workflows: ["Instagram Daily Data Collection"]
    types:
      - completed

jobs:
  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
    - name: Create failure issue
      uses: actions/github-script@v6
      with:
        script: |
          const title = `🚨 Daily Data Collection Failed - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Data Collection Failure Alert
          
          **実行日時**: ${new Date().toISOString()}
          **ワークフロー**: ${context.payload.workflow_run.html_url}
          
          ### 確認事項
          - [ ] Instagram API トークンの有効性
          - [ ] Supabase 接続状況
          - [ ] 環境変数設定
          - [ ] API制限の確認
          
          ### 対応
          1. 上記ワークフローのログを確認
          2. エラーの原因を特定
          3. 必要に応じて手動でデータ収集を実行
          
          ---
          *このissueは自動生成されました*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'automated']
          });
```

---

## B0403: 日次実行テスト (3時間)

### 実装戦略

#### 1. ローカルテストスクリプト作成 (1時間)
**ファイル**: `scripts/test_daily_collection.py`

```python
#!/usr/bin/env python3
"""
Local test script for daily data collection
GitHub Actions 実行前のローカルテスト用
"""

import asyncio
import os
from daily_data_collection import collect_all_instagram_data

async def test_local_collection():
    """Test data collection locally before GitHub Actions deployment"""
    
    print("🧪 Daily Data Collection - ローカルテスト開始")
    
    # Environment check
    required_env = ['SUPABASE_URL', 'SUPABASE_KEY']
    missing_env = [env for env in required_env if not os.getenv(env)]
    
    if missing_env:
        print(f"❌ Missing environment variables: {', '.join(missing_env)}")
        return False
    
    # Run collection
    results = await collect_all_instagram_data()
    
    # Validate results
    success = len(results.get('errors', [])) == 0
    
    print(f"\n🏁 ローカルテスト完了: {'成功' if success else '失敗'}")
    return success

if __name__ == "__main__":
    import sys
    success = asyncio.run(test_local_collection())
    sys.exit(0 if success else 1)
```

#### 2. GitHub Actions 手動テスト (1時間)
**手順**:
1. ワークフローファイルをコミット・プッシュ
2. GitHub Actions で手動実行
3. ログ・結果の確認
4. エラーがあれば修正・再テスト

#### 3. スケジュール実行検証 (1時間)
**検証項目**:
- スケジュール通りに実行される
- データが正しく収集・保存される
- エラー時の通知が機能する
- ログが適切に出力される

---

## 完了条件

### B0401 (収集スクリプト作成)
- [ ] `scripts/daily_data_collection.py` 作成・動作確認
- [ ] `scripts/setup_environment.py` 作成
- [ ] `scripts/requirements.txt` 作成
- [ ] `scripts/report_generator.py` 作成
- [ ] ローカル環境でのエンドツーエンド動作確認

### B0402 (GitHub Actionsワークフロー)
- [ ] `.github/workflows/daily-data-collection.yml` 作成
- [ ] `.github/workflows/notify-on-failure.yml` 作成  
- [ ] `docs/deployment/github-actions-setup.md` 作成
- [ ] GitHub Secrets 設定完了
- [ ] 手動実行での動作確認

### B0403 (日次実行テスト)
- [ ] ローカルテストスクリプト作成・実行
- [ ] GitHub Actions 手動実行テスト
- [ ] スケジュール実行の検証
- [ ] エラーハンドリング・通知機能の確認
- [ ] 7日間の継続実行での安定性確認

## PoC配慮事項
- **シンプルな構成**: 複雑な分岐処理は最小限
- **エラーハンドリング**: 基本的なログ出力のみ
- **通知**: GitHub Issue 作成による最小限の通知
- **スケジュール**: 日次 1回のシンプルな実行
- **依存関係**: 必要最小限のパッケージのみ

## 技術選択理由
- **GitHub Actions**: 無料枠内で利用可能、リポジトリと統合
- **Python スクリプト**: 既存のバックエンドコードを再利用
- **Ubuntu runner**: 安定性とコスト効率のバランス
- **Cron スケジュール**: シンプルで確実な日次実行

## 実装時間見積
- **B0401**: 6時間（スクリプト作成・テスト）
- **B0402**: 3時間（ワークフロー作成・設定）
- **B0403**: 3時間（テスト・検証・調整）
- **合計**: 12時間（1.5日）

Instagram分析アプリの**完全自動化データ収集システム**が完成し、GitHub Actionsによる**毎日の自動実行**を実現。