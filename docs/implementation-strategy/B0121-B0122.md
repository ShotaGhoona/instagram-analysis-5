# B0121 & B0122: 認証API実装

## 概要
バックエンドの基本認証API機能実装。既存のsimple_auth.pyとdatabase.pyの完成と動作テスト。

## 実装戦略

### 1. 現状確認・依存関係チェック (30分)
- simple_auth.pyとdatabase.pyのコード確認
- 必要な依存パッケージ確認（pyjwt, passlib等）
- SECRET_KEY環境変数設定

### 2. データベース接続テスト (30分)
- users テーブル作成確認
- DatabaseManagerのuser操作メソッドテスト
- Supabaseクライアント接続確認

### 3. 認証API動作テスト (60分)
- POST /auth/register エンドポイントテスト
- POST /auth/login エンドポイントテスト
- JWT トークン生成・検証テスト
- エラーハンドリング確認

### 4. フロントエンド連携テスト (30分)
- 実際のテストユーザー作成
- フロントエンドからのログインテスト
- トークン永続化動作確認

## 実装内容

### 依存パッケージ確認
```bash
# 必要なパッケージを確認・インストール
pip install pyjwt passlib[bcrypt]
```

### 環境変数設定
```bash
# backend/.env に追加
SECRET_KEY=your-secret-key-for-production
```

### API動作テスト用スクリプト
```python
# test_auth_api.py
import requests
import asyncio
from models.database import db_manager

async def test_auth_flow():
    base_url = "http://localhost:8000"
    
    # 1. 新規ユーザー登録テスト
    register_data = {
        "username": "testuser",
        "password": "testpass123"
    }
    
    response = requests.post(f"{base_url}/auth/register", json=register_data)
    print(f"Register response: {response.status_code}")
    
    if response.status_code == 200:
        token = response.json()["access_token"]
        print(f"Registration successful. Token: {token[:20]}...")
        
        # 2. ログインテスト
        login_data = {
            "username": "testuser", 
            "password": "testpass123"
        }
        
        login_response = requests.post(f"{base_url}/auth/login", json=login_data)
        print(f"Login response: {login_response.status_code}")
        
        if login_response.status_code == 200:
            login_token = login_response.json()["access_token"]
            print(f"Login successful. Token: {login_token[:20]}...")
```

### 既存コード検証ポイント
```python
# simple_auth.py の主要機能が実装済み確認
- ✅ パスワードハッシュ化 (bcrypt)
- ✅ JWT トークン生成・検証
- ✅ POST /auth/register エンドポイント
- ✅ POST /auth/login エンドポイント
- ✅ POST /auth/logout エンドポイント
- ✅ GET /auth/me エンドポイント

# database.py の必要メソッド実装済み確認
- ✅ create_user()
- ✅ get_user_by_username()
- ✅ User モデル定義
```

### テスト手順
1. **バックエンド起動**: `uvicorn main:app --reload`
2. **ユーザー登録**: POST /auth/register でテストユーザー作成
3. **ログインテスト**: POST /auth/login でトークン取得
4. **フロントエンド連携**: 実際のログインフォームでテスト

## 完了条件
- [ ] 依存パッケージインストール完了
- [ ] SECRET_KEY環境変数設定完了
- [ ] POST /auth/register が正常動作
- [ ] POST /auth/login が正常動作
- [ ] JWT トークン生成・検証が正常動作
- [ ] フロントエンドからのログインが成功
- [ ] エラーケース（無効なユーザー名・パスワード）の適切なハンドリング

## PoC配慮
- 既存コードがほぼ完成しているため実装作業は最小限
- 主に動作確認とテストに集中
- 高度なセキュリティ設定は不要（SECRET_KEY設定のみ）
- エラーハンドリングは基本レベルでOK

## 次のタスク
認証API完成後、Instagram API統合(B0201)やデータ収集(B0401)に進む