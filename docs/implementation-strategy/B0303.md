# B0303: 月間分析API実装戦略

## 概要
月間分析API（GET /analytics/monthly/{account_id}）の実装。日別統計、詳細データ取得を行うバックエンドエンドポイント作成。B0302（年間分析API）パターンを踏襲してClean Architecture準拠で実装する。

## 実装戦略

### 1. Repository層メソッド拡張 (2.5時間)
`backend/repositories/instagram_repository.py`に日別統計メソッド追加
- **get_daily_account_stats()**: 指定月の日別アカウント統計取得
- **get_daily_media_stats_aggregation()**: 指定月の日別投稿統計取得
- **get_monthly_summary()**: 月間サマリー情報取得
- **日付フィルタリング**: year/month指定での期間絞り込み

### 2. APIエンドポイント実装 (2時間)
`backend/api/analytics.py`の既存get_monthly_analyticsメソッド実装
- **パラメータ**: account_id（必須）、year（必須）、month（必須）
- **レスポンス**: MonthlyAnalytics型（既存types.py準拠）
- **エラーハンドリング**: アカウント存在確認、データなし対応
- **認証**: get_current_user依存性注入

### 3. データ処理ロジック (1時間)
日別データの取得・整形処理
- **期間計算**: 指定年月の1日〜月末日までの範囲
- **日別統計**: 投稿数、新規フォロワー、リーチ、プロフィール閲覧、ウェブサイトクリック
- **データ補完**: データなし日のゼロ埋め処理
- **データ整形**: DailyStats[]形式での返却

### 4. 動作確認・テスト (0.5時間)
- **手動テスト**: test_monthly_analytics.pyスクリプト作成
- **フロントエンド統合**: F0403で確認予定
- **エラーケース**: 存在しないアカウント、未来月指定

## 完了条件
- [ ] Repository層に日別統計メソッド追加
- [ ] APIエンドポイントが正常にレスポンス返却
- [ ] MonthlyAnalytics型に準拠したデータ構造
- [ ] エラーハンドリング（404、400、500）適切に動作
- [ ] 認証機能が正常動作
- [ ] 手動テストで正常データ取得確認

## 技術仕様

### API仕様
```python
@router.get("/monthly/{account_id}", response_model=MonthlyAnalytics)
async def get_monthly_analytics(
    account_id: str,
    year: int = Query(..., description="対象年"),
    month: int = Query(..., ge=1, le=12, description="対象月（1-12）"),
    current_user: User = Depends(get_current_user)
)
```

### APIレスポンス例
```json
{
  "account_id": "mock_account_1",
  "month": "2025-03",
  "daily_stats": [
    {
      "date": "2025-03-01",
      "posts_count": 0,
      "new_followers": 2,
      "reach": 158,
      "profile_views": 10,
      "website_clicks": 0
    },
    {
      "date": "2025-03-02", 
      "posts_count": 2,
      "new_followers": 0,
      "reach": 84,
      "profile_views": 0,
      "website_clicks": 0
    },
    // ... 31日分のデータ
  ]
}
```

### レスポンス型定義（既存types.ts準拠）
```typescript
interface MonthlyAnalytics {
  account_id: string
  month: string              // "YYYY-MM"形式
  daily_stats: DailyStats[]
}

interface DailyStats {
  date: string              // "YYYY-MM-DD"形式
  posts_count: number       // その日の投稿数
  new_followers: number     // その日の新規フォロワー増減
  reach: number            // その日のリーチ数
  profile_views: number    // その日のプロフィール閲覧数
  website_clicks: number   // その日のウェブサイトクリック数
}
```

### Repository実装例
```python
async def get_daily_account_stats(
    self, 
    ig_user_id: str, 
    year: int, 
    month: int
) -> List[Dict]:
    # 指定月の全日データを取得
    start_date = f"{year}-{month:02d}-01"
    # 月末日を計算
    if month == 12:
        end_date = f"{year + 1}-01-01"
    else:
        end_date = f"{year}-{month + 1:02d}-01"
    
    query = self.client.table('daily_account_stats').select('*')
    query = query.eq('ig_user_id', ig_user_id)
    query = query.gte('date', start_date).lt('date', end_date)
    
    result = query.order('date').execute()
    return result.data
```

### データ補完ロジック
```python
def fill_missing_days(data: List[Dict], year: int, month: int) -> List[Dict]:
    """データなし日をゼロ埋めで補完"""
    from calendar import monthrange
    
    days_in_month = monthrange(year, month)[1]
    filled_data = []
    
    for day in range(1, days_in_month + 1):
        date_str = f"{year}-{month:02d}-{day:02d}"
        
        # 既存データを検索
        existing = next((d for d in data if d['date'] == date_str), None)
        
        if existing:
            filled_data.append(existing)
        else:
            # ゼロ埋めデータ
            filled_data.append({
                'date': date_str,
                'posts_count': 0,
                'new_followers': 0,
                'reach': 0,
                'profile_views': 0,
                'website_clicks': 0
            })
    
    return filled_data
```

## エラーハンドリング仕様

### バリデーション
- **年月範囲**: 1900-2100年、1-12月
- **未来日制限**: 現在月より未来の指定は400エラー
- **アカウント存在**: 404エラー

### エラーレスポンス
- **400**: Bad Request（無効な年月指定）
- **404**: アカウント不存在
- **500**: Internal Server Error（データベースエラー）

## PoC配慮
- **既存パターン踏襲**: B0302年間分析APIと同じ構造
- **シンプルな集計**: 基本的な日別集計のみ
- **データ補完**: 欠損日のゼロ埋め対応
- **パフォーマンス**: 1ヶ月分のデータのみなので高速動作

## 次への依存関係
- **F0403 フロントエンド統合**: このAPI実装後にmockデータ→リアルAPI切り替え
- **既存API統合**: 年間分析API（B0302）と同じパターンで実装