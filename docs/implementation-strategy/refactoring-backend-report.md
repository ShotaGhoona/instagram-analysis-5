# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…ãƒ¬ãƒãƒ¼ãƒˆ
Clean Architectureæº–æ‹ ã®ã‚³ãƒ¼ãƒ‰æ•´ç†ãƒ»çµ±ä¸€

## ğŸ“‹ å®Ÿè£…æ¦‚è¦

**å®Ÿè£…æ—¥**: 2025-09-09  
**å¯¾è±¡**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°  
**ç›®çš„**: Clean Architectureæº–æ‹ ã€é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã€è²¬å‹™ã®æ˜ç¢ºåŒ–

## âœ… å®Œäº†ã—ãŸä½œæ¥­

### 1. é‡è¤‡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçµ±åˆ
**å•é¡Œ**: `core/database.py` ã¨ `utils/supabase_client.py` ã®é‡è¤‡å®Ÿè£…

**å®Ÿæ–½å†…å®¹**:
- âœ… `core/database.py`ã‚’æ¨™æº–ã¨ã—ã¦æ¡ç”¨
- âœ… `utils/supabase_client.py`ã‚’å®Œå…¨å‰Šé™¤ (41è¡Œå‰Šé™¤)
- âœ… ç’°å¢ƒå¤‰æ•°ã‚’`SUPABASE_ANON_KEY`ã«çµ±ä¸€
- âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‚ç…§ã‚’`core/database`ã«ä¿®æ­£

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
```diff
- backend/utils/supabase_client.py                  | 41è¡Œå‰Šé™¤
- backend/core/config.py                           | SUPABASE_KEY â†’ SUPABASE_ANON_KEY
- backend/core/database.py                         | ç’°å¢ƒå¤‰æ•°å‚ç…§ä¿®æ­£
- backend/test/test_database.py                    | importæ–‡ä¿®æ­£
```

### 2. ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ¢ãƒ‡ãƒ«å‰Šé™¤
**å•é¡Œ**: `models/database.py`ãŒä»–ãƒ•ã‚¡ã‚¤ãƒ«ã¨å®Œå…¨é‡è¤‡

**å®Ÿæ–½å†…å®¹**:
- âœ… é‡è¤‡ç¢ºèª: `models/user.py`, `models/instagram.py`ã«åŒã˜ãƒ¢ãƒ‡ãƒ«å­˜åœ¨
- âœ… `models/database.py`å®Œå…¨å‰Šé™¤ (224è¡Œå‰Šé™¤)
- âœ… æœªä½¿ç”¨`DatabaseManager`ã‚¯ãƒ©ã‚¹å‰Šé™¤

**Clean Architectureãƒ¢ãƒ‡ãƒ«æ§‹é€ **:
```
models/
â”œâ”€â”€ user.py          âœ… User, UserCreate, UserLogin
â”œâ”€â”€ instagram.py     âœ… InstagramAccount, MediaPost, DailyStats + Request/Response
â”œâ”€â”€ analytics.py     âœ… Analyticså°‚ç”¨Responseãƒ¢ãƒ‡ãƒ«
â””â”€â”€ sql/             âœ… DDL/DMLã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

### 3. èªè¨¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„
**å•é¡Œ**: `auth/`ãŒç‹¬ç«‹å±¤ã¨ã—ã¦å­˜åœ¨ï¼ˆClean Architectureé•åï¼‰

**å®Ÿæ–½å†…å®¹**:
- âœ… `auth/` â†’ `middleware/auth/`ã«ç§»å‹•
- âœ… æ¨ªæ–­çš„é–¢å¿ƒäº‹ï¼ˆCross-cutting Concernï¼‰ã¨ã—ã¦é©åˆ‡é…ç½®
- âœ… å…¨APIå‚ç…§ã‚’ä¿®æ­£

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
```diff
- backend/main.py                                  | from auth.* â†’ from middleware.auth.*
- backend/api/accounts.py                          | importä¿®æ­£
- backend/api/analytics.py                         | importä¿®æ­£  
- backend/api/media.py                            | importä¿®æ­£
- backend/api/setup.py                            | importä¿®æ­£
```

### 4. ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†
**å•é¡Œ**: ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã«æ•£åœ¨ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ«

**å®Ÿæ–½å†…å®¹**:
- âœ… 8å€‹ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’`backend/test/`ã«çµ±åˆ
- âœ… ãƒ‡ãƒãƒƒã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
- âœ… ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã®æ•´ç†å®Œäº†

**ç§»å‹•ãƒ•ã‚¡ã‚¤ãƒ«**:
```
backend/collect_all_accounts_data.py   â†’ backend/test/
backend/debug_insights_api.py          â†’ backend/test/
backend/test_*.py (8ãƒ•ã‚¡ã‚¤ãƒ«)           â†’ backend/test/
```

### 5. SQLãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†
**å®Ÿæ–½å†…å®¹**:
- âœ… `backend/sql/` â†’ `backend/models/sql/`ã«ç§»å‹•
- âœ… ãƒ‡ãƒ¼ã‚¿é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’modelsé…ä¸‹ã«çµ±åˆ

## ğŸ“Š ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°çµ±è¨ˆ

### ã‚³ãƒ¼ãƒ‰å‰Šæ¸›é‡
| ãƒ•ã‚¡ã‚¤ãƒ« | å‰Šé™¤è¡Œæ•° | å†…å®¹ |
|----------|----------|------|
| `utils/supabase_client.py` | 41è¡Œ | é‡è¤‡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| `models/database.py` | 224è¡Œ | é‡è¤‡ãƒ¢ãƒ‡ãƒ«å®šç¾© |
| `utils/README.md` | 37è¡Œ | ä¸è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| **åˆè¨ˆå‰Šé™¤** | **302è¡Œ** | **ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰é™¤å»** |

### ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ãƒ»æ•´ç†
- **ç§»å‹•ãƒ•ã‚¡ã‚¤ãƒ«**: 16å€‹
- **å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«**: 3å€‹
- **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: 8å€‹

## ğŸ—ï¸ Clean Architectureå®Ÿç¾

### Beforeï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰ï¼‰
```
backend/
â”œâ”€â”€ api/
â”œâ”€â”€ auth/              âŒ ç‹¬ç«‹ã—ãŸèªè¨¼å±¤
â”œâ”€â”€ core/
â”œâ”€â”€ external/
â”œâ”€â”€ models/
â”œâ”€â”€ repositories/
â”œâ”€â”€ services/
â”œâ”€â”€ utils/             âŒ é‡è¤‡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”œâ”€â”€ sql/               âŒ å ´æ‰€ãŒä¸é©åˆ‡
â””â”€â”€ test_*.py          âŒ ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«æ•£åœ¨
```

### Afterï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œï¼‰
```
backend/
â”œâ”€â”€ api/              âœ… Interface Adapters (REST endpoints)
â”œâ”€â”€ middleware/       âœ… Cross-cutting Concerns
â”‚   â””â”€â”€ auth/         âœ… èªè¨¼ã‚’é©åˆ‡é…ç½®
â”œâ”€â”€ services/         âœ… Use Cases (Business logic)
â”œâ”€â”€ repositories/     âœ… Infrastructure (Data access)
â”œâ”€â”€ external/         âœ… Infrastructure (Third-party APIs)
â”œâ”€â”€ models/           âœ… Entities (Data models)
â”‚   â””â”€â”€ sql/          âœ… ãƒ‡ãƒ¼ã‚¿é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆ
â”œâ”€â”€ core/             âœ… Configuration & Database
â””â”€â”€ test/             âœ… å…¨ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆ
```

## ğŸ”§ æŠ€è¡“çš„æ”¹å–„

### 1. ç’°å¢ƒå¤‰æ•°çµ±ä¸€
**çµ±ä¸€å‰**: `SUPABASE_KEY` ã¨ `SUPABASE_ANON_KEY`ã®æ··åœ¨
**çµ±ä¸€å¾Œ**: å…¨ã‚³ãƒ¼ãƒ‰ã§`SUPABASE_ANON_KEY`ä½¿ç”¨

### 2. Importæ–‡ã®æ•´ç†
**çµ±ä¸€å‰**:
```python
from auth.simple_auth import get_current_user
from utils.supabase_client import supabase_client  # é‡è¤‡
```

**çµ±ä¸€å¾Œ**:
```python
from middleware.auth.simple_auth import get_current_user
from core.database import database  # çµ±ä¸€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
```

### 3. è²¬å‹™ã®æ˜ç¢ºåŒ–
- **Middleware**: æ¨ªæ–­çš„é–¢å¿ƒäº‹ï¼ˆèªè¨¼ãƒ»CORSãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
- **Core**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŸºç›¤ï¼ˆè¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
- **Models**: ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã¨SQLå®šç¾©ã®çµ±åˆ

## âœ… å“è³ªå‘ä¸ŠåŠ¹æœ

### 1. ä¿å®ˆæ€§å‘ä¸Š
- âœ… é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã«ã‚ˆã‚Šå˜ä¸€è²¬ä»»åŸå‰‡ã‚’å®Ÿç¾
- âœ… Clean Architectureæº–æ‹ ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ä¾å­˜é–¢ä¿‚æ˜ç¢ºåŒ–
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®ã®è«–ç†çš„æ•´ç†

### 2. é–‹ç™ºä½“é¨“æ”¹å–„
- âœ… Importæ–‡ã®ä¸€è²«æ€§å‘ä¸Š
- âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®é›†ç´„ã«ã‚ˆã‚‹å®Ÿè¡ŒåŠ¹ç‡åŒ–
- âœ… èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®ç™ºè¦‹æ€§å‘ä¸Š

### 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å“è³ª
- âœ… æ¨ªæ–­çš„é–¢å¿ƒäº‹ã®é©åˆ‡ãªåˆ†é›¢
- âœ… Infrastructureå±¤ã®çµ±ä¸€
- âœ… Domainå±¤ï¼ˆModelsï¼‰ã®ç´”ç²‹æ€§å‘ä¸Š

## ğŸ”„ ä»Šå¾Œã®æ‹¡å¼µæ€§

### è¿½åŠ å¯èƒ½ãªMiddleware
```
middleware/
â”œâ”€â”€ auth/             âœ… å®Œæˆ
â”œâ”€â”€ cors/             ğŸ”„ ä»Šå¾Œè¿½åŠ å¯èƒ½
â”œâ”€â”€ error_handling/   ğŸ”„ B0501/B0502ã§å®Ÿè£…äºˆå®š
â””â”€â”€ logging/          ğŸ”„ ä»Šå¾Œè¿½åŠ å¯èƒ½
```

### Infrastructureçµ±åˆã®å¯èƒ½æ€§
```
infrastructure/       ğŸ”„ å°†æ¥çš„ãªçµ±åˆå€™è£œ
â”œâ”€â”€ database/         (core/database)
â”œâ”€â”€ external/         (external/instagram_client)
â””â”€â”€ auth/             (middleware/auth)
```

## ğŸ“ˆ æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€ (B0501/B0502)
- HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¨™æº–åŒ–
- `middleware/error_handling/`å®Ÿè£…
- Pydanticæ´»ç”¨ã®å…¥åŠ›æ¤œè¨¼å¼·åŒ–

### Phase 2: Clean Architectureå®Œå…¨å®Ÿè£…
- `dto/` - Data Transfer Objects
- `exceptions/` - ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹
- `validators/` - å…¥åŠ›æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯

## ğŸ¯ æˆæœã‚µãƒãƒªãƒ¼

**âœ… å®Œäº†ã—ãŸæ”¹å–„**:
- 302è¡Œã®ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰å‰Šé™¤
- Clean Architectureæº–æ‹ ã®æ§‹é€ å®Ÿç¾
- é‡è¤‡ãƒ»ä¸æ•´åˆã®å®Œå…¨è§£æ¶ˆ
- èªè¨¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é©åˆ‡ãªé…ç½®

**ğŸ“Š å“è³ªæŒ‡æ¨™**:
- ã‚³ãƒ¼ãƒ‰é‡è¤‡ç‡: å¤§å¹…å‰Šæ¸›
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æº–æ‹ : Clean Architectureå®Ÿç¾
- ä¿å®ˆæ€§: å¤§å¹…å‘ä¸Š
- æ‹¡å¼µæ€§: å°†æ¥å¯¾å¿œåŸºç›¤æ§‹ç¯‰

**ğŸš€ é–‹ç™ºåŠ¹ç‡åŒ–**:
- Importæ–‡ã®ä¸€è²«æ€§ã«ã‚ˆã‚‹é–‹ç™ºä½“é¨“å‘ä¸Š
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®åŠ¹ç‡åŒ–
- æ–°æ©Ÿèƒ½é–‹ç™ºæ™‚ã®è¿·ã„ã‚’å‰Šæ¸›

---

## ğŸ“ æŠ€è¡“çš„å‚™è€ƒ

### Gitå·®åˆ†ã‚µãƒãƒªãƒ¼
```
24 files changed, 13 insertions(+), 316 deletions(-)
```

### é‡è¦ãªå¤‰æ›´
1. **Database Clientçµ±ä¸€**: ç’°å¢ƒå¤‰æ•°ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ã®å®Œå…¨çµ±ä¸€
2. **èªè¨¼ã®å†é…ç½®**: auth â†’ middleware/auth ã§Cross-cutting Concernã‚’å®Ÿç¾
3. **ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰å‰Šé™¤**: é‡è¤‡ãƒ¢ãƒ‡ãƒ«ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Œå…¨é™¤å»
4. **ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ æœ€é©åŒ–**: Clean Architectureæº–æ‹ ã®è«–ç†çš„é…ç½®

ğŸ‰ **Instagram Analytics ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†ï¼**