# B0302: 年間分析API実装戦略

## 概要
年間分析API（GET /analytics/yearly/{account_id}）の実装。月別集計、推移データ生成を行うバックエンドエンドポイント作成。既存のB0301（投稿分析API）パターンを踏襲してClean Architecture準拠で実装する。

## 実装戦略

### 1. Repository層メソッド拡張 (2時間)
`backend/repositories/instagram_repository.py`に月別集計メソッド追加
- **get_monthly_account_stats()**: 月別アカウント統計取得
- **get_monthly_media_aggregation()**: 月別投稿集計データ取得
- **既存JOINクエリ活用**: daily_account_stats + daily_media_stats結合
- **SQL集計関数使用**: SUM, AVG, COUNT での月別グループ化

### 2. APIエンドポイント実装 (2時間)
`backend/api/analytics.py`の既存get_yearly_analyticsメソッド実装
- **パラメータ**: account_id（必須）、year（オプション）
- **レスポンス**: YearlyAnalytics型（既存types.py準拠）
- **エラーハンドリング**: アカウント存在確認、データなし対応
- **認証**: get_current_user依存性注入

### 3. データ処理ロジック (1.5時間)
月別データの計算・整形処理
- **期間設定**: デフォルト年間、指定年対応
- **月別集計**: フォロワー数推移、エンゲージメント合計
- **平均エンゲージメント率計算**: 全投稿の加重平均
- **データ整形**: MonthlyStats[]形式での返却

### 4. 動作確認・テスト (0.5時間)
- **手動テスト**: 既存test/debug_insights_api.pyパターン
- **フロントエンド統合**: F0304で確認予定
- **エラーケース**: 存在しないアカウント、データなし期間

## 完了条件
- [ ] Repository層に月別集計メソッド追加
- [ ] APIエンドポイントが正常にレスポンス返却
- [ ] YearlyAnalytics型に準拠したデータ構造
- [ ] エラーハンドリング（404、500）適切に動作
- [ ] 認証機能が正常動作
- [ ] 手動テストで正常データ取得確認

## 技術仕様

### API仕様
```python
@router.get("/yearly/{account_id}", response_model=YearlyAnalytics)
async def get_yearly_analytics(
    account_id: str,
    year: Optional[int] = Query(None, description="対象年（未指定時は全期間）"),
    current_user: User = Depends(get_current_user)
)
```

### APIレスポンス例
```json
{
  "account_id": "mock_account_1",
  "total_posts": 36,
  "avg_engagement_rate": 10.5,
  "monthly_stats": [
    {
      "month": "2023-04",
      "followers_count": 728,
      "follows_count": 2,
      "media_count": 5,
      "profile_views": 17,
      "website_clicks": 0,
      "total_likes": 14,
      "total_comments": 0,
      "total_shares": 0,
      "total_saved": 0
    },
    {
      "month": "2024-02",
      "followers_count": 740,
      "follows_count": 740,
      "media_count": 3,
      "profile_views": 1,
      "website_clicks": 0,
      "total_likes": 0,
      "total_comments": 0,
      "total_shares": 0,
      "total_saved": 0
    },
    {
      "month": "2024-03",
      "followers_count": 743,
      "follows_count": -14,
      "media_count": 12,
      "profile_views": 6,
      "website_clicks": 0,
      "total_likes": 105,
      "total_comments": 0,
      "total_shares": 0,
      "total_saved": 0
    }
  ]
}
```

### レスポンス型定義（既存types.ts準拠）
```typescript
interface YearlyAnalytics {
  account_id: string
  monthly_stats: MonthlyStats[]
  total_posts: number
  avg_engagement_rate: number
}

interface MonthlyStats {
  month: string                 // "YYYY-MM"形式
  followers_count: number       // 月末フォロワー数
  follows_count: number         // 新規フォロワー増減数
  media_count: number          // 月間投稿数
  profile_views: number        // 月間プロフィール閲覧数
  website_clicks: number       // 月間ウェブサイトクリック数
  total_likes: number          // 月間総いいね数
  total_comments: number       // 月間総コメント数
  total_shares: number         // 月間総シェア数
  total_saved: number          // 月間総保存数
}
```

### Repository実装例
```python
async def get_monthly_account_stats(
    self, 
    ig_user_id: str, 
    year: Optional[int] = None
) -> List[Dict]:
    query = """
    SELECT 
        DATE_TRUNC('month', date) as month,
        AVG(followers_count) as followers_count,
        SUM(profile_views) as profile_views,
        SUM(website_clicks) as website_clicks
    FROM daily_account_stats 
    WHERE ig_user_id = %s
    GROUP BY DATE_TRUNC('month', date)
    ORDER BY month
    """
```

## PoC配慮
- **既存パターン踏襲**: B0301投稿分析APIと同じ構造
- **シンプルな集計**: 複雑な統計処理は避ける
- **エラーハンドリング最小限**: HTTPステータスコードのみ
- **パフォーマンス**: インデックス活用、基本的なクエリ最適化

## 次への依存関係
- **F0304 フロントエンド統合**: このAPI実装後にmockデータ→リアルAPI切り替え
- **B0303 月間分析API**: 同じパターンで実装予定