# F0102: 認証状態管理

## 概要
認証状態の管理とリダイレクト処理の実装。ログイン後に適切な分析ページに遷移する。

## 実装戦略

### 1. 認証ガード作成 (45分)
```bash
mkdir -p frontend/src/components/auth
touch frontend/src/components/auth/auth-guard.tsx
```

### 2. 認証フック改善 (30分) 
- useAuthにリダイレクト処理追加
- ページリロード時の認証状態復元
- useRouterとの連携

### 3. ルート保護適用 (30分)
- ログインページに未認証専用ガード適用
- トップページ（`/`）に認証ガード適用

### 4. 動作確認 (15分)
- ログイン成功後のトップページ遷移確認
- 未認証時のログインリダイレクト確認

## 実装内容

### AuthGuardコンポーネント
```tsx
// components/auth/auth-guard.tsx
interface AuthGuardProps {
  children: React.ReactNode
  requireAuth?: boolean
  fallbackUrl?: string
}

export function AuthGuard({ children, requireAuth = true, fallbackUrl = '/login' }: AuthGuardProps) {
  const { user, isLoading } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (!isLoading) {
      if (requireAuth && !user) {
        router.push(fallbackUrl)
      } else if (!requireAuth && user) {
        // 認証済み時はトップページにリダイレクト
        router.push('/')
      }
    }
  }, [user, isLoading, requireAuth, fallbackUrl, router])

  if (isLoading) {
    return <div className="flex items-center justify-center min-h-screen">読み込み中...</div>
  }

  return <>{children}</>
}
```

### 認証フック改善
```tsx
// hooks/use-auth.tsx の login関数更新
const login = async (username: string, password: string) => {
  try {
    const response = await apiClient.login(username, password)
    apiClient.setToken(response.access_token)
    setUser({ id: 1, username, created_at: new Date().toISOString() })
    
    // ログイン成功後はトップページへ
    window.location.href = '/'
  } catch (error) {
    throw error
  }
}
```

### ルート保護適用
```tsx
// app/login/page.tsx (更新)
import { AuthGuard } from '@/components/auth/auth-guard'

export default function LoginPage() {
  return (
    <AuthGuard requireAuth={false}>
      {/* 既存のログインフォーム */}
    </AuthGuard>
  )
}

// app/page.tsx (更新)
import { AuthGuard } from '@/components/auth/auth-guard'

export default function HomePage() {
  return (
    <AuthGuard requireAuth={true}>
      <div className="min-h-screen p-6">
        <h1 className="text-3xl font-bold">Instagram Analytics</h1>
        <p className="text-gray-600 mt-2">Instagram分析アプリのホームページ</p>
      </div>
    </AuthGuard>
  )
}
```

## 認証フロー
```
未認証ユーザー → /login → ログイン成功 → /
認証済みユーザー → /login にアクセス → / にリダイレクト
```

## 完了条件
- [ ] `/login`で認証済みユーザーがトップページ（`/`）にリダイレクト
- [ ] ログイン成功時にトップページ（`/`）に遷移
- [ ] 未認証ユーザーが保護ページアクセス時に`/login`リダイレクト
- [ ] ページリロード時の認証状態復元
- [ ] ローディング状態の表示

## PoC配慮
- トークン検証APIは未実装（localStorage存在チェックのみ）
- トップページは空のプレースホルダーでOK
- エラーハンドリングは最小限