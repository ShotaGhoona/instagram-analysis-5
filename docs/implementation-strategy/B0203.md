# B0203: メディア投稿取得

## 概要
Instagram Graph APIから投稿データを取得する機能を実装。GitHub Actions日次データ収集の基盤となる機能。
verification/endpoint-testsで**完全動作確認済み**（3アカウント、30件の投稿データ取得成功）。

## 実装戦略

### 1. Instagram APIクライアント拡張 (1時間)
**ファイル**: `backend/external/instagram_client.py`

```python
def get_user_media(self, ig_user_id: str, access_token: str, limit: int = 25) -> Dict[str, Any]:
    """Get Instagram media posts for an account"""
    # 検証済みフィールド構成を使用
    fields = 'id,timestamp,media_type,caption,like_count,comments_count,media_url,thumbnail_url,permalink'
    params = {
        'fields': fields,
        'limit': limit,
        'access_token': access_token
    }
    return self.graph_api_request(f'/{ig_user_id}/media', params)
```

### 2. データベースリポジトリ拡張 (1時間)
**ファイル**: `backend/repositories/instagram_repository.py`

```python
async def save_media_posts(self, media_posts: List[Dict]) -> int:
    """Save media posts to database (UPSERT)"""
    # media_postsテーブルへの保存処理
    
async def get_media_posts(self, ig_user_id: str, limit: int = 25) -> List[Dict]:
    """Get media posts from database"""
    # timestamp DESC順でソート
```

### 3. API エンドポイント実装 (1時間)
**ファイル**: `backend/api/media.py`

既存のTODO部分を実装：
- `get_media_posts()` - 投稿一覧取得
- `get_media_with_stats()` - 統計付き投稿一覧（投稿分析ページ用）

### 4. 動作確認 (30分)
- 既存検証スクリプトでAPI動作確認
- データベース保存・取得テスト

## 完了条件
- [ ] `instagram_client.py` に `get_user_media()` メソッド追加
- [ ] `instagram_repository.py` にメディア投稿CRUD操作追加  
- [ ] `api/media.py` のTODO実装完了
- [ ] 検証スクリプトでエンドツーエンド動作確認
- [ ] 新規投稿の検出・保存が動作

## PoC配慮
- **エラーハンドリング**: 最小限（API制限・トークン失効のみ）
- **パフォーマンス**: 考慮しない（limit=25固定）
- **キャッシュ**: 実装しない
- **VIDEO投稿**: 検証データになし→後回し（// TODO: 動画対応）
- **セキュリティ**: アクセストークン検証のみ
- **pagination**: GitHub Actions用途では不要（最新25件で十分）

## 依存関係
- **前提**: B0151-B0153 (Instagram APIクライアント・トークン管理) ✅ 完了済み
- **連携**: B0204 (インサイトデータ取得) - 同一クライアント使用
- **活用**: B0401 (GitHub Actions データ収集) - この機能を使用

## 制約・注意事項
- Instagram API制限: 200リクエスト/時間
- アクセストークン有効期限: 60日間
- 投稿データサイズ: キャプション最大2200文字
- 検証済み投稿タイプ: IMAGE, CAROUSEL_ALBUM （VIDEO未検証）