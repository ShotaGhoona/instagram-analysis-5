# B0151-B0152-B0153: Instagram APIクライアント + セットアップAPI + トークンリフレッシュ

## 概要
Instagram APIクライアント作成からトークン管理機能まで一気通貫で実装。既存のverificationフォルダの検証結果を活用し、セットアップページで使用可能なバックエンド機能を完成させる。

## 現状確認
- **検証済み**: verification/endpoint-tests/ で25アカウントの検証・トークンリフレッシュ成功
- **DB準備完了**: instagram_accountsテーブル存在、DatabaseManagerクラス実装済み
- **フロントエンド**: /setupページ作成済み（ダミー動作）
- **環境変数**: INSTAGRAM_APP_ID, INSTAGRAM_APP_SECRET 設定が必要

## 実装戦略

### 1. Instagram APIクライアント実装 (60分)
- `utils/instagram_client.py` 作成
- verificationのInstagramAPIClientクラスを参考に簡略化
- 必要な機能のみ実装:
  - `/me/accounts` でページ・アカウント取得
  - `fb_exchange_token` でトークン長期化
  - Graph APIリクエスト共通処理

### 2. セットアップAPI実装 (90分)
- `api/setup.py` 作成
- **POST /setup/refresh-tokens** エンドポイント
- リクエスト: `{ app_id, app_secret, access_token }`
- レスポンス: `{ success, updated_accounts, new_accounts, errors }`
- Instagram APIクライアント使用してトークンリフレッシュ実行

### 3. トークンリフレッシュロジック実装 (90分)
- **全アカウント取得・更新処理**
- 新規アカウント自動登録
- 既存アカウントトークン更新
- エラーハンドリング（API制限、無効トークンなど）
- データベースへの保存・更新

### 4. 統合テスト・動作確認 (30分)
- /setupページからの実際の動作確認
- verificationデータでの動作テスト

## ファイル構成
```
backend/
├── utils/
│   └── instagram_client.py          # 新規作成
├── api/
│   └── setup.py                     # 新規作成
└── models/
    └── database.py                  # 既存（トークン更新メソッド追加）
```

## 完了条件
- [ ] Instagram APIクライアント作成（`utils/instagram_client.py`）
- [ ] セットアップAPI作成（`POST /setup/refresh-tokens`）
- [ ] トークンリフレッシュ機能実装（全アカウント処理）
- [ ] DatabaseManagerにトークン更新メソッド追加
- [ ] /setupページから実際にリフレッシュ動作確認
- [ ] エラーハンドリング（無効トークン、API制限等）

## PoC配慮
- **セキュリティ**: 最小限（トークンはプレーンテキスト保存）
- **エラーハンドリング**: 基本的なもののみ
- **パフォーマンス**: 同期処理で問題なし
- **ログ**: print文レベルで十分
- **バリデーション**: 基本的なもののみ

## 依存関係
- **前提**: B0202（アカウント情報取得API）完了済み
- **後続**: B0201（API認証統合）、B0203-B0206（各種データ取得API）

## 時間見積もり
- **合計**: 4.5時間
- B0151: 1時間
- B0152: 1.5時間  
- B0153: 1.5時間
- 統合テスト: 0.5時間