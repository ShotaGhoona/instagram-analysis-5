name: Collection Failure Notification

on:
  workflow_run:
    workflows: ["Instagram Daily Data Collection"]
    types:
      - completed

jobs:
  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: Get workflow run details
      id: workflow_details
      run: |
        echo "workflow_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
        echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
        echo "run_number=${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
        echo "created_at=${{ github.event.workflow_run.created_at }}" >> $GITHUB_OUTPUT
        
        # Format date in JST
        CREATED_JST=$(date -d "${{ github.event.workflow_run.created_at }}" '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S JST' 2>/dev/null || echo "${{ github.event.workflow_run.created_at }}")
        echo "created_jst=$CREATED_JST" >> $GITHUB_OUTPUT
    
    - name: Create failure issue
      uses: actions/github-script@v6
      with:
        script: |
          const title = `ğŸš¨ Daily Data Collection Failed - ${new Date().toISOString().split('T')[0]}`;
          const workflowUrl = '${{ steps.workflow_details.outputs.workflow_url }}';
          const runId = '${{ steps.workflow_details.outputs.run_id }}';
          const runNumber = '${{ steps.workflow_details.outputs.run_number }}';
          const createdJst = '${{ steps.workflow_details.outputs.created_jst }}';
          
          const body = `## ğŸš¨ Instagram ãƒ‡ãƒ¼ã‚¿åé›†å¤±æ•—ã‚¢ãƒ©ãƒ¼ãƒˆ
          
          **å®Ÿè¡Œæ—¥æ™‚**: ${createdJst}
          **å®Ÿè¡Œç•ªå·**: #${runNumber}
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼URL**: ${workflowUrl}
          
          ### ğŸ“‹ ç¢ºèªäº‹é …
          - [ ] Instagram API ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª
          - [ ] Supabase ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šçŠ¶æ³ã‚’ç¢ºèª
          - [ ] GitHub Secrets ã®ç’°å¢ƒå¤‰æ•°è¨­å®šã‚’ç¢ºèª
          - [ ] Instagram APIåˆ¶é™ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰ã®ç¢ºèª
          - [ ] å„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™ã‚’ç¢ºèª
          
          ### ğŸ” èª¿æŸ»æ‰‹é †
          1. **ãƒ­ã‚°ç¢ºèª**: ä¸Šè¨˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’è©³ã—ãç¢ºèª
          2. **ã‚¨ãƒ©ãƒ¼ç‰¹å®š**: å¤±æ•—ã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç‰¹å®š
          3. **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ³**: Instagram Business Accounts ã®çŠ¶æ³ã‚’ç¢ºèª
          4. **APIåˆ¶é™**: Instagram Graph API ã®åˆ¶é™çŠ¶æ³ã‚’ç¢ºèª
          5. **ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°**: å¿…è¦ã«å¿œã˜ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°
          
          ### ğŸ› ï¸ å¯¾å¿œã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          - [ ] ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã—ä¿®æ­£
          - [ ] å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ãƒ‡ãƒ¼ã‚¿åé›†ã‚’å®Ÿè¡Œ
          - [ ] ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ãŒå¿…è¦ãªå ´åˆã¯ \`/settings/setup\` ã§æ›´æ–°
          - [ ] ä¿®æ­£å¾Œã€æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œ
          
          ### ğŸ“Š å½±éŸ¿ç¯„å›²
          - æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿åé›†ãŒå¤±æ•—
          - ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒæœªåé›†ã®å¯èƒ½æ€§:
            - æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ (æ–°è¦æŠ•ç¨¿ã®æ¤œå‡ºãƒ»ä¿å­˜)
            - æŠ•ç¨¿ã‚¤ãƒ³ã‚µã‚¤ãƒˆ (ãƒªãƒ¼ãƒã€ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç­‰)
            - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³ã‚µã‚¤ãƒˆ (ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã€ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚¯ãƒªãƒƒã‚¯)
          
          ### ğŸ”„ å¾©æ—§æ–¹æ³•
          1. **æ‰‹å‹•å®Ÿè¡Œ**: Actions ã‚¿ãƒ–ã‹ã‚‰ "Instagram Daily Data Collection" ã‚’æ‰‹å‹•å®Ÿè¡Œ
          2. **ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰**: å•é¡Œèª¿æŸ»ã®ãŸã‚ã€ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®æ‰‹å‹•å®Ÿè¡Œã‚’æ¨å¥¨
          3. **æ¬¡å›å®Ÿè¡Œ**: å•é¡ŒãŒè§£æ±ºã•ã‚Œã‚Œã°æ˜æ—¥ã®å®šæœŸå®Ÿè¡Œã¯æ­£å¸¸ã«å‹•ä½œäºˆå®š
          
          ---
          
          **âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**
          - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œ](../../actions/workflows/daily-data-collection.yml)
          - [Instagram ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š](/settings/setup)
          - [Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://supabase.com/dashboard)
          
          ---
          *ã“ã®issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ (Run ID: ${runId})*
          `;
          
          // Check if an issue for today already exists
          const today = new Date().toISOString().split('T')[0];
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'automated,data-collection-failure',
            state: 'open'
          });
          
          const todayIssue = existingIssues.data.find(issue => 
            issue.title.includes(today)
          );
          
          if (todayIssue) {
            // Update existing issue with additional run information
            const updateBody = todayIssue.body + `\n\n---\n\n**ğŸ”„ è¿½åŠ å¤±æ•— (${createdJst})**\n- å®Ÿè¡Œç•ªå·: #${runNumber}\n- URL: ${workflowUrl}`;
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: todayIssue.number,
              body: updateBody
            });
            
            console.log(`Updated existing issue #${todayIssue.number}`);
          } else {
            // Create new issue
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automated', 'data-collection-failure', 'high-priority']
            });
            
            console.log(`Created new issue #${newIssue.data.number}`);
          }
    
    - name: Log notification completion
      run: |
        echo "ğŸ”” é€šçŸ¥å‡¦ç†å®Œäº†"
        echo "ğŸ“… å¤±æ•—æ—¥æ™‚: ${{ steps.workflow_details.outputs.created_jst }}"
        echo "ğŸ”— ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼URL: ${{ steps.workflow_details.outputs.workflow_url }}"
        echo "ğŸ“‹ GitHub Issue ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ"