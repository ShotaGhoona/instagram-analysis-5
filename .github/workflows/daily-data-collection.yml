name: Instagram Daily Data Collection

on:
  schedule:
    # æ¯æ—¥ JST 09:00 (UTC 00:00) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      test_mode:
        description: 'Run in test mode (dry run)'
        required: false
        default: 'false'
        type: boolean

env:
  # Set timezone for consistent logging
  TZ: 'Asia/Tokyo'

jobs:
  collect-instagram-data:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 120åˆ†(2æ™‚é–“)ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - 98ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¯¾å¿œ
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
    
    - name: Set up environment variables
      run: |
        echo "DEBUG_MODE=${{ inputs.debug || 'false' }}" >> $GITHUB_ENV
        echo "TEST_MODE=${{ inputs.test_mode || 'false' }}" >> $GITHUB_ENV
        echo "GITHUB_RUN_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
    
    - name: Verify environment setup
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
        INSTAGRAM_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
      run: |
        echo "ğŸ”§ ç’°å¢ƒå¤‰æ•°æ¤œè¨¼é–‹å§‹..."
        python scripts/setup_environment.py
    
    - name: Run Instagram data collection
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
        INSTAGRAM_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
      run: |
        echo "ğŸš€ Instagram ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹..."
        echo "ğŸ“… å®Ÿè¡Œæ—¥æ™‚: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S %Z')"
        echo "ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${{ env.DEBUG_MODE }}"
        echo "ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ env.TEST_MODE }}"
        echo ""
        
        # Run the main data collection script
        python scripts/daily_data_collection.py
    
    - name: Generate collection report
      if: always()  # æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
      run: |
        echo "ğŸ“„ åé›†ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        
        # Find the most recent results file
        RESULTS_FILE=$(find scripts/ -name "collection_results_*.json" -type f -printf '%T@ %p\n' 2>/dev/null | sort -nr | head -n1 | cut -d' ' -f2- || echo "")
        
        if [ -n "$RESULTS_FILE" ] && [ -f "$RESULTS_FILE" ]; then
          echo "ğŸ“Š çµæœãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: $RESULTS_FILE"
          python scripts/report_generator.py "$RESULTS_FILE"
        else
          echo "âš ï¸ çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        echo "âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
    
    - name: Upload collection results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: collection-results-${{ github.run_id }}
        path: |
          scripts/collection_results_*.json
          scripts/collection_report_*.md
          scripts/local_test_report.md
        retention-days: 30
        if-no-files-found: warn
        overwrite: true
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_id }}
        path: |
          scripts/*.log
          logs/
        retention-days: 7
        if-no-files-found: ignore
        overwrite: true
    
    - name: Collection summary
      if: always()
      run: |
        echo "ğŸ Instagram Data Collection å®Œäº†"
        echo "ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼:"
        echo "   ğŸ• å®Ÿè¡Œæ™‚é–“: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S %Z')"
        echo "   ğŸ”— å®Ÿè¡ŒURL: ${{ env.GITHUB_RUN_URL }}"
        echo "   ğŸ“ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
        echo "   ğŸ”€ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
        echo ""
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… ãƒ‡ãƒ¼ã‚¿åé›†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        else
          echo "âŒ ãƒ‡ãƒ¼ã‚¿åé›†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          echo "ğŸ” è©³ç´°ãªãƒ­ã‚°ã¯ä¸Šè¨˜ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi